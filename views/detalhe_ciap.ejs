<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalhe - CIAP</title>
  <link rel="stylesheet" href="/css/detalhe-ciap.css" />
  <link rel="icon" href="/assets/logo.png" type="image/png">
  <script src="/js/api.js"></script>
</head>

<body>
  <div class="detalhe-container">
    <!-- NAVBAR -->
    <%- include('./partials/navbar'); %>

      <!-- BOT√ïES HEADER -->
      <div class="container-header-btn">
        <button class="btn-header" onclick="location.href='/sintomas/diagnosticos'">üìÉ Diagn√≥sticos</button>
        <button class="btn-header" onclick="location.href='/sintomas/queixas'">ü©∫ Sintomas</button>
      </div>

      <!-- CARD TITULO -->
      <header class="detalhe-header">
        <p class="detalhe-subtitle">Detalhes</p>
        <h2 id="detalhe-title" class="detalhe-title">Carregando...</h2>
      </header>

      <!-- CARD LISTA -->
      <div id="detalhe-content" class="detalhe-content">
        <div class="detail-card">
          <div class="detail-body">Carregando detalhes...</div>
        </div>
      </div>
  </div>

  <script>
    const serverCodigo = '<%= typeof codigo !== "undefined" ? codigo : "" %>';

    /**
     * L√™ o c√≥digo do CIAP a partir da URL da p√°gina.
     *
     * @returns {string} O c√≥digo encontrado na URL ou string vazia se n√£o existir
     */
    function lerCodigoUrl() {
      const parts = location.pathname.split('/');
      return parts[parts.length - 1] || '';
    }

    /**
     * Busca e renderiza os detalhes do CIAP na p√°gina.
     * Obt√©m o c√≥digo, requisita dados e exibe as se√ß√µes detalhadas (sintomas, CID-10, etc).
     */
    async function renderDetalhe() {
      const codigo = serverCodigo || lerCodigoUrl();

      if (!codigo) {
        document.getElementById('detalhe-content').innerHTML = '<div>C√≥digo inv√°lido</div>';
        return;
      }

      const resp = await getDetalhesCiap(codigo);

      if (!resp.success) {
        setContentMessage('Erro ao carregar detalhes');
        return;
      }

      const detalhe = resp.data && resp.data.detalhes;
      const subSintomas = detalhe && Array.isArray(detalhe.subSintomas) ? detalhe.subSintomas : [];

      if (!detalhe) {
        document.getElementById('detalhe-title').textContent = 'Detalhe n√£o encontrado';
        setContentMessage(`Detalhe n√£o encontrado para o c√≥digo: ${codigo}`);
        return;
      }

      document.getElementById('detalhe-title').textContent = `${detalhe.codigo} ‚Äî ${detalhe.nomeLeigo || ''}`;

      const sections = [];

      if (subSintomas.length > 0) {
        subSintomas.sort((a, b) => a.nome.localeCompare(b.nome, 'pt', { sensitivity: 'base' }));

        const ITEMS_INICIAIS = 10;
        const temMaisItens = subSintomas.length > ITEMS_INICIAIS;
        const itemsIniciais = subSintomas.slice(0, ITEMS_INICIAIS);
        const itemsRestantes = subSintomas.slice(ITEMS_INICIAIS);

        const uniqueId = `subsintomas-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;

        sections.push(buildSection('Sintomas Associados', `
          <ul class="detail-list" id="${uniqueId}-visible">
            ${itemsIniciais.map(s => `<li>${capitalWord(s.nome)}</li>`).join('')}
          </ul>
          ${temMaisItens ? `
          <ul class="detail-list subsintomas-hidden" id="${uniqueId}-hidden" style="display: none;">
            ${itemsRestantes.map(s => `<li>${capitalWord(s.nome)}</li>`).join('')}
          </ul>
          <button class="btn-ver-mais" onclick="toggleSubSintomas('${uniqueId}')" id="${uniqueId}-btn">
            Ver mais (${itemsRestantes.length} ${itemsRestantes.length === 1 ? 'sintoma' : 'sintomas'})
          </button>
          ` : ''}
        `));
      }

      if (detalhe.sintomasInclusos && detalhe.sintomasInclusos.trim() !== '') {
        sections.push(buildSection('Sintomas inclusos', `<p>${capitalWord(detalhe.sintomasInclusos)}</p>`));
      }

      if (detalhe.sintomasExclusao && detalhe.sintomasExclusao.trim() !== '') {
        sections.push(buildSection('Sintomas de exclus√£o', `<p>${detalhe.sintomasExclusao}</p>`));
      }

      if (detalhe.outrosSintomas && detalhe.outrosSintomas.trim() !== '') {
        sections.push(buildSection('Outros sintomas', `<p>${detalhe.outrosSintomas}</p>`));
      }

      if (detalhe.possiveisCid10 && detalhe.possiveisCid10.trim() !== '') {
        sections.push(buildSection('Poss√≠veis CID-10', `<p>${detalhe.possiveisCid10}</p>`));
      }

      const html = sections.length > 0
        ? sections.join('')
        : buildSection('Informa√ß√µes adicionais', '<p>Nenhum detalhe complementar dispon√≠vel para este item.</p>');

      document.getElementById('detalhe-content').innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', renderDetalhe);

    /**
     * Exibe uma mensagem no elemento de detalhes da p√°gina.
     * Utilizado para avisos (ex: quando n√£o h√° detalhes encontrados).
     * 
     * @param {string} message - Mensagem a ser exibida
     */
    function setContentMessage(message) {
      document.getElementById('detalhe-content').innerHTML = `
        <div class="detail-card">
          <div class="detail-body">${message}</div>
        </div>`;
    }

    /**
     * Monta um bloco/se√ß√£o de detalhe HTML padronizada.
     *
     * @param {string} title - T√≠tulo da se√ß√£o (por exemplo: "Sintomas Associados")
     * @param {string} content - Conte√∫do HTML a ser inserido dentro da se√ß√£o (pode conter listas, par√°grafos, etc)
     * @returns {string} HTML da se√ß√£o montada, j√° pronta para injetar via innerHTML
     */
    function buildSection(title, content) {
      return `
        <section class="detail-card">
          <div class="detail-card-header">
            <h2 class="detail-title">${title}</h2>
          </div>
          <div class="detail-body">
            ${content}
          </div>
        </section>
      `;
    }

    /**
     * Converte a primeira letra de uma string para mai√∫scula e mant√©m o restante inalterado.
     * 
     * @param {string} string - A string a ser capitalizada.
     * @returns {string} A string com a primeira letra em mai√∫scula.
     */
    function capitalWord(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    /**
     * Alterna a visualiza√ß√£o entre a lista resumida e completa de subSintomas.
     * Mostra/oculta os itens adicionais e atualiza o texto do bot√£o.
     * 
     * @param {string} uniqueId - ID √∫nico da se√ß√£o de subSintomas
     */
    function toggleSubSintomas(uniqueId) {
      const hiddenList = document.getElementById(`${uniqueId}-hidden`);
      const btn = document.getElementById(`${uniqueId}-btn`);

      if (!hiddenList || !btn) return;

      const isHidden = hiddenList.style.display === 'none' || hiddenList.style.display === '';
      if (isHidden) {
        hiddenList.style.display = 'flex';
        btn.textContent = 'Ver menos';
        btn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } else {
        hiddenList.style.display = 'none';
        btn.textContent = `Ver mais (${hiddenList.children.length} ${hiddenList.children.length === 1 ? 'sintoma' : 'sintomas'})`;
      }
    }
  </script>
</body>

</html>