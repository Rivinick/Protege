<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalhe - CIAP</title>
  <link rel="stylesheet" href="/css/detalhe-ciap.css" />
  <link rel="icon" href="/assets/logo.png" type="image/png">
  <script src="/js/api.js"></script>
</head>

<body>
  <div class="detalhe-container">
    <%- include('./partials/navbar'); %>

      <div class="container-header-btn">
        <button class="btn-header" onclick="location.href='/sintomas/diagnosticos'">üìÉ Diagn√≥sticos</button>
        <button class="btn-header" onclick="location.href='/sintomas/queixas'">ü©∫ Sintomas</button>
      </div>

      <header class="detalhe-header">
        <p class="detalhe-subtitle">Detalhes</p>
        <h2 id="detalhe-title" class="detalhe-title">Carregando...</h2>
      </header>

      <div id="detalhe-content" class="detalhe-content">
        <div class="detail-card">
          <div class="detail-body">Carregando detalhes...</div>
        </div>
      </div>
  </div>

  <script>
    const serverCodigo = '<%= typeof codigo !== "undefined" ? codigo : "" %>';
    function readCodigoFromUrl() {
      const parts = location.pathname.split('/');
      return parts[parts.length - 1] || '';
    }

    async function renderDetalhe() {
      const codigo = serverCodigo || readCodigoFromUrl();

      if (!codigo) {
        document.getElementById('detalhe-content').innerHTML = '<div>C√≥digo inv√°lido</div>';
        return;
      }

      const resp = await getDetalhesCiap(codigo);

      if (!resp.success) {
        setContentMessage('Erro ao carregar detalhes');
        return;
      }

      const detalhe = resp.data && resp.data.detalhes;
      const subSintomas = detalhe && Array.isArray(detalhe.subSintomas) ? detalhe.subSintomas : [];

      if (!detalhe) {
        document.getElementById('detalhe-title').textContent = 'Detalhe n√£o encontrado';
        setContentMessage(`Detalhe n√£o encontrado para o c√≥digo: ${codigo}`);
        return;
      }

      document.getElementById('detalhe-title').textContent = `${detalhe.codigo} ‚Äî ${detalhe.nomeLeigo || ''}`;

      const sections = [];

      if (subSintomas.length > 0) {
        subSintomas.sort((a, b) => a.nome.localeCompare(b.nome, 'pt', { sensitivity: 'base' }));
        
        sections.push(buildSection('Sintomas Associados', `
          <ul class="detail-list">
            ${subSintomas.map(s => `<li>${capitalWord(s.nome)}</li>`).join('')}
            </ul>
        `));
      }

      if (detalhe.sintomasInclusos && detalhe.sintomasInclusos.trim() !== '') {
        sections.push(buildSection('Sintomas inclusos', `<p>${capitalWord(detalhe.sintomasInclusos)}</p>`));
      }

      if (detalhe.sintomasExclusao && detalhe.sintomasExclusao.trim() !== '') {
        sections.push(buildSection('Sintomas de exclus√£o', `<p>${detalhe.sintomasExclusao}</p>`));
      }

      if (detalhe.outrosSintomas && detalhe.outrosSintomas.trim() !== '') {
        sections.push(buildSection('Outros sintomas', `<p>${detalhe.outrosSintomas}</p>`));
      }

      if (detalhe.possiveisCid10 && detalhe.possiveisCid10.trim() !== '') {
        sections.push(buildSection('Poss√≠veis CID-10', `<p>${detalhe.possiveisCid10}</p>`));
      }

      const html = sections.length > 0
        ? sections.join('')
        : buildSection('Informa√ß√µes adicionais', '<p>Nenhum detalhe complementar dispon√≠vel para este item.</p>');

      document.getElementById('detalhe-content').innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', renderDetalhe);

    function setContentMessage(message) {
      document.getElementById('detalhe-content').innerHTML = `
        <div class="detail-card">
          <div class="detail-body">${message}</div>
        </div>`;
    }

    function buildSection(title, content) {
      return `
        <section class="detail-card">
          <div class="detail-card-header">
            <h2 class="detail-title">${title}</h2>
          </div>
          <div class="detail-body">
            ${content}
          </div>
        </section>
      `;
    }

    function capitalWord(string) {
      return string.charAt(0).toUpperCase() + string.slice(1);
    }
  </script>
</body>

</html>